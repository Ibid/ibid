#!/usr/bin/env python

from sys import argv, exit
from optparse import OptionParser

from twisted.spread import pb
from twisted.internet import reactor
from twisted.python import util

parser = OptionParser(usage='%prog [options] message <message> | plugin <plugin> <class> <method> <params>')
parser.add_option('-s', '--server', help='Hostname of Ibid instance')
parser.add_option('-p', '--port', help='Port number of Ibid instance')
parser.set_defaults(server='localhost', port=8789, message=True, plugin=False)
options, args = parser.parse_args()
command = args[0].lower()

factory = pb.PBClientFactory()
reactor.connectTCP(options.server, options.port, factory)
d = factory.getRootObject()

if command == 'message':
	if len(args) < 2:
		parser.print_help()
		exit(1)
	d.addCallback(lambda object: object.callRemote('message', ' '.join(args[1:])))

elif command == 'plugin':
	if len(args) < 4:
		parser.print_help()
		exit(1)
	d.addCallback(lambda root: root.callRemote('get_plugin', args[1], args[2]))
	d.addCallback(lambda plugin: plugin.callRemote(args[3], *args[4:]))

d.addCallback(lambda response: response)
d.addErrback(lambda reason: 'Error: %s' % str(reason.value))
d.addCallback(util.println)
d.addCallback(lambda _: reactor.stop())
reactor.run()

# vi: set et sta sw=4 ts=4:
