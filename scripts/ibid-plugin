#!/usr/bin/env python

import logging
from optparse import OptionParser
from os import getenv
from sys import exit

try:
    import readline
except ImportError:
    pass

import ibid
import ibid.plugins
from ibid.config import FileConfig
from ibid.event import Event
from ibid.models import Identity

parser = OptionParser(usage="%prog [options...] [plugins...]")
parser.add_option("-a", "--all", dest="load_all", action="store_true",
        help="Load all configured plugins")
parser.add_option("-o", "--only", dest="load_base", action="store_false", default=True,
        help="Only load the specified plugins, not the common base plugins")
parser.add_option("-s", "--skip", dest="skip", action="append", metavar="PLUGIN",
        help="Skip loading PLUGIN (may be specified more than once)")

(options, args) = parser.parse_args()

if options.load_all and not options.load_base:
    parser.error("Incompatible combination: --all and --only")

# Setup Ibid core:

def auth_responses(event, permission):
    return True

ibid.plugins.auth_responses = auth_responses
ibid.options = {'base': '.'}

logging.basicConfig(level=logging.DEBUG)
ibid.config = FileConfig("ibid.ini")
ibid.config.merge(FileConfig("local.ini"))
ibid.reload_reloader()
ibid.reloader.reload_databases()
ibid.reloader.reload_dispatcher()

plugins = set(args)
if options.load_all:
    plugins = set(ibid.config.get("load"))
if options.load_base:
    plugins |= set(("admin", "config", "core", "help", "test"))
if options.skip:
    plugins -= set(options.skip)

for plugin in plugins:
    ibid.reloader.load_processor(plugin)

username = unicode(getenv('USER'))
if not username:
    username = u'tester'
session = ibid.databases.ibid()
identity = session.query(Identity).filter_by(identity=username).first()
if not identity:
    identity = Identity(u'test_source',username)
    session.save(identity)
    session.flush()
    identity = session.query(Identity).filter_by(identity=username).first()
identity_id = identity.id

try:
    encoding = getenv("LANG").split(".")[1]
except:
    encoding = "ascii"

log = logging.getLogger('scripts.ibid-plugin')

while True:
    event = Event(u'test_source', u'message')
    event.sender['id'] = event.sender['connection'] = event.sender['nick'] = username
    event.identity = identity_id
    event.account =  None
    event.addressed = True
    event.public = False
    event.channel = u"testchan"

    try:
        event.message = unicode(raw_input('Query: '), encoding)
    except (KeyboardInterrupt, EOFError):
        break

    for processor in ibid.processors:
        try:
            processor.process(event)
        except Exception:
            log.exception(u"Exception occured in %s processor of %s plugin", processor.__class__.__name__, processor.name)

    for response in event.responses:
        if isinstance(response, dict):
            response = response['reply']
        print 'Response: %s' % response

print "\nExiting"

# vi: set et sta sw=4 ts=4:
