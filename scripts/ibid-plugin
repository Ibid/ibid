#!/usr/bin/env python

from sys import argv, exit
from traceback import print_exc
import logging

if len(argv) != 2:
    print 'Usage: %s plugin' % (argv[0], )
    exit(1)

import os
import ibid
import ibid.plugins
from ibid.config import FileConfig
from ibid.event import Event
from ibid.models import Identity


def auth_responses(event, permission):
    return True

ibid.plugins.auth_responses = auth_responses
ibid.options = {'base': '.'}

logging.basicConfig(level=logging.DEBUG)
ibid.config = FileConfig("ibid.ini")
ibid.config.merge(FileConfig("local.ini"))
ibid.reload_reloader()
ibid.reloader.reload_databases()
ibid.reloader.reload_dispatcher()
ibid.reloader.load_processor(argv[1])

username = unicode(os.getenv('USER'))
if not username:
    username = u'test_plugin'
session = ibid.databases.ibid()
identity = session.query(Identity).filter_by(identity=username).first()
if not identity:
    identity = Identity(u'test_plugin',username)
    session.add(identity)
    session.flush()
    identity = session.query(Identity).filter_by(identity=username).first()
identity_id = identity.id

while True:
    try:
        event = Event('test_plugin', 'message')
        event.who = event.sender = event.sender_id = event.channel = 'test_plugin'
        event.identity = identity_id
        event.account =  None
        event.addressed = True
        event.public = False
        event.message = unicode(raw_input('Query: '))
        for processor in ibid.processors:
            processor.process(event)
        for response in event.responses:
            if isinstance(response, dict):
                response = response['reply']
            print 'Response: %s' % response
#        print event
    except Exception, e:
        print_exc()

# vi: set et sta sw=4 ts=4:
